library(ggplot2)
library(magrittr)
library(multcompView)
library(plyr)
library(car)

generate_label_df <- function(HSD, flev, n){    #HSD is an object generated by TukeyHSD(), flev is the variable containing the levels of the factor,  n is the number of the column containing the dependent variable
  #Extract labels and factor levels from Tukey post-hoc 
  Tukey.levels <- HSD[[flev]][,4]
  Tukey.labels <- multcompLetters(Tukey.levels)['Letters']
  plot.labels <- names(Tukey.labels[['Letters']])
  # Get highest quantile for Tukey's 5 number summary and add a bit of space to buffer between    
  # upper quantile and label placement
  boxplot.df <- ddply(data, flev, function (x) max(fivenum(x[[n]])) + 0.8)
  # Create a data frame out of the factor levels and Tukey's homogenous group letters
  plot.levels <- data.frame(lab = plot.labels,
                            labels = Tukey.labels[['Letters']],
                            stringsAsFactors = FALSE)
  # Merge it with the labels
  labels.df <- merge(plot.levels, boxplot.df, by.x = 'lab', by.y = flev, sort = FALSE)
  return(labels.df)
}
